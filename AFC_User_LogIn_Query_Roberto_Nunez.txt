IF object_id('tempdb.dbo.#t') is not null
	drop table #t
create table #t (userPrincipalName varchar(100));
insert into #t values ('ADAM.T.NISSON.CIV')
insert into #t values ('adan.parra1.mil')
insert into #t values ('ADRIAN.PW.FYFE.FM')
insert into #t values ('adrian.v.smith.mil')
insert into #t values ('ADRIAN.VELEZ.MIL')
insert into #t values ('ALDO.D.ABITBOL.CIV')
insert into #t values ('ALDO.J.CASTRO-SANTOS.CIV')
insert into #t values ('alex.g.ornstein2.civ')
insert into #t values ('alexandra.t.cromie.mil')
insert into #t values ('amaury.b.ochart.civ')
insert into #t values ('Ambrose.c.rosario.civ')
insert into #t values ('ammar.m.masoud.mil')
insert into #t values ('analyn.r.rodriguez.civ')
insert into #t values ('andrea.l.gwynn.civ')
insert into #t values ('ANGELA.N.NICHOLS4.CIV')
insert into #t values ('anita.a.howard4.civ')
insert into #t values ('anna.magazinnik.civ')
insert into #t values ('ANTHONY.E.HUGHLEY.MIL')
insert into #t values ('arjun.kurup.civ')
insert into #t values ('Arturo.cornejo.civ')
insert into #t values ('aubrey.s.lavitoria.civ')
insert into #t values ('augusta.z.hemann.civ')
insert into #t values ('AUSTIN.A.BOONE.MIL')
insert into #t values ('barbara.j.calhoun2.civ')
insert into #t values ('BILLIE.L.STOKES.CIV')
insert into #t values ('billy.r.michael4.civ')
insert into #t values ('blake.m.macon.civ')
insert into #t values ('blas.c.rueda-caraballo.civ')
insert into #t values ('brent.o.skinner.mil')
insert into #t values ('brian.a.sessler.civ')
insert into #t values ('BRIANNE.L.EWING.MIL')
insert into #t values ('bryan.p.jonas.mil ')
insert into #t values ('bryant.c.lambert.civ')
insert into #t values ('cali.d.garcia.civ')
insert into #t values ('CANDACE.E.AKINS.CIV')
insert into #t values ('carl.e.tucker.civ')
insert into #t values ('CARL.W.HALE4.CIV')
insert into #t values ('carolina.cruz.mil')
insert into #t values ('CATHERINE.G.ROBERTSON.MIL')
insert into #t values ('celeste.j.kennamer.civ')
insert into #t values ('Charles.w.broughton.civ')
insert into #t values ('charlotte.m.cordero.civ')
insert into #t values ('christine.a.carruthers.civ')
insert into #t values ('christine.d.dash.civ')
insert into #t values ('CHRISTOPHER.A.LINZ.CIV')
insert into #t values ('christopher.c.brewton.civ')
insert into #t values ('christopher.d.lovelace4.civ')
insert into #t values ('christopher.s.harvey3.mil')
insert into #t values ('christopher.j.lowrance.mil')
insert into #t values ('christopher.j.zimmer2.mil')
insert into #t values ('christopher.m.cummings3.civ')
insert into #t values ('Christopher.m.ford6.mil')
insert into #t values ('christopher.s.cropper.ctr')
insert into #t values ('COLIN.DARBY.CIV')
insert into #t values ('connor.a.maloney.civ')
insert into #t values ('corey.a.walker7.mil')
insert into #t values ('CORY.J.DELGER.MIL')
insert into #t values ('CYNTHIA.L.PITTMAN.CIV')
insert into #t values ('cynthia.m.fiorino.ctr')
insert into #t values ('danarius.m.hemphill.civ')
insert into #t values ('DANIEL.H.KANE.CIV')
insert into #t values ('dante.e.milledge.civ')
insert into #t values ('darrin.h.kay.civ')
insert into #t values ('davey.p.vargas.civ')
insert into #t values ('DAVID.F.FARIAS.CIV')
insert into #t values ('David.j.docimo.civ')
insert into #t values ('david.l.futch2.civ')
insert into #t values ('david.m.ferrer4.civ')
insert into #t values ('david.s.huerta2.civ')
insert into #t values ('david.s.thompson56.civ')
insert into #t values ('Dina.Mabry.civ')
insert into #t values ('Dionne.r.dunham.civ')
insert into #t values ('EBONY.A.JOLLY.MIL')
insert into #t values ('edward.r.phelps4.ctr')
insert into #t values ('edwin.delacruz2.mil')
insert into #t values ('Elise.m.joseph2.civ')
insert into #t values ('Elizabeth.a.arwine.civ')
insert into #t values ('elizabeth.a.kissee.civ')
insert into #t values ('elliot.d.werner.mil')
insert into #t values ('ELVA.MADRIGAL.CIV')
insert into #t values ('EMILY.C.ARZAGA.CIV')
insert into #t values ('enrique.rivera1.civ')
insert into #t values ('ERIC.C.RISHEL.CIV')
insert into #t values ('eric.D.greer.civ')
insert into #t values ('eric.j.carreau.civ')
insert into #t values ('erica.l.graves4.civ')
insert into #t values ('Erica.s.fessler.civ')
insert into #t values ('fawn.n.miller.civ')
insert into #t values ('felicia.r.owens.civ')
insert into #t values ('FRANCES.C.KAUHL.MIL')
insert into #t values ('francisco.torres20.civ')
insert into #t values ('gary.h.gonzalez.civ')
insert into #t values ('george.k.gordon.civ')
insert into #t values ('gerhard.w.rickert.ctr')
insert into #t values ('gina.e.adam.mil')
insert into #t values ('Glidden.j.torres-estela.civ')
insert into #t values ('gregory.m.hotchkiss.civ')
insert into #t values ('gregory.r.smith3.civ')
insert into #t values ('haley.a.steele.mil')
insert into #t values ('HANS.B.HONERLAH.CIV')
insert into #t values ('hector.l.rivera3.civ')
insert into #t values ('hoa.a.diep.mil')
insert into #t values ('indira.g.williams.civ')
insert into #t values ('isaiah.delgado.ctr')
insert into #t values ('JACK.H.COOPERMAN.MIL')
insert into #t values ('JACOB.A.BOWEN8.MIL')
insert into #t values ('JACQUELINE.M.NEWELL.MIL')
insert into #t values ('James.l.denton.civ')
insert into #t values ('James.m.martin2.civ')
insert into #t values ('JAMES.R.ORBOCK2.CIV')
insert into #t values ('jana.d.torres.civ')
insert into #t values ('Jason.l.epstein.civ')
insert into #t values ('javier.o.rogelespinoza.civ')
insert into #t values ('JAY.C.COATS.MIL')
insert into #t values ('jeffrey.e.baker12.mil')
insert into #t values ('Jeffrey.l.withers.civ')
insert into #t values ('jeffrey.r.kwasniewski.civ')
insert into #t values ('Jennifer.c.brewster.mil')
insert into #t values ('jennifer.l.pacheco19.civ')
insert into #t values ('jeremiah.d.collins.civ')
insert into #t values ('jessica.m.collins26.civ')
insert into #t values ('jimmy.o.perez.civ')
insert into #t values ('Jody.d.morris.civ')
insert into #t values ('JODY.M.PAPPENFUS.CIV')
insert into #t values ('johanna.t.wynne.mil')
insert into #t values ('john.c.colbert.civ')
insert into #t values ('JOHN.C.KUMP.MIL')
insert into #t values ('JOHN.D.BARRINGTON.MIL')
insert into #t values ('John.h.untersee.civ')
insert into #t values ('john.m.keeter2.civ')
insert into #t values ('Johnna.i.thompson.civ')
insert into #t values ('JONATHAN.A.BODENHAMER.MIL')
insert into #t values ('Jonathan.lee30.civ')
insert into #t values ('Jose.r.latorre2.mil')
insert into #t values ('joseph.a.wucik.civ')
insert into #t values ('joseph.i.gilbert.mil')
insert into #t values ('joseph.j.stanko.civ')
insert into #t values ('joshua.l.bodenheimer.civ')
insert into #t values ('JUAN.C.SEGURA.MIL')
insert into #t values ('judy.e.crowder.civ')
insert into #t values ('Julian.q.mcmillan.civ')
insert into #t values ('justin.l.ramirez2.ctr')
insert into #t values ('kara.l.stetson.civ')
insert into #t values ('karma.k.vance.civ')
insert into #t values ('kathryn.s.mather.civ')
insert into #t values ('katrina.m.mansfield.civ')
insert into #t values ('kelsey.d.kennard.mil')
insert into #t values ('kenneth.m.wanless2.mil')
insert into #t values ('Kenneth.t.loncarich.civ')
insert into #t values ('kenton.b.satterwhite.mil')
insert into #t values ('kevin.p.leitch.civ')
insert into #t values ('KIM.M.MCGRAW.CIV')
insert into #t values ('kimberly.y.stewart.civ')
insert into #t values ('kizzy.mayfield2.civ')
insert into #t values ('kristopher.j.weygant.civ')
insert into #t values ('lailaan.m.anderson.mil')
insert into #t values ('lakreisha.l.johnson.civ')
insert into #t values ('lashonda.n.williams2.civ')
insert into #t values ('lawrence.m.stout.civ')
insert into #t values ('LEAH.R.LUCIO.CIV')
insert into #t values ('Leslie.d.figueroa.civ')
insert into #t values ('liam.j.kozma.mil ')
insert into #t values ('linda.destasi.civ')
insert into #t values ('LISA.FORMOSO.CIV')
insert into #t values ('LISA.K.CRAMER.CIV')
insert into #t values ('LISA.M.CASTRO6.CIV')
insert into #t values ('LORRIE.A.ESPINOZA2.CTR')
insert into #t values ('louis.c.brousseau.civ')
insert into #t values ('Lucas.e.brown.mil')
insert into #t values ('marcus.r.stone.ctr')
insert into #t values ('Margaret.e.morris10.civ')
insert into #t values ('MARIBEL.L.RAMBUYAN.CIV')
insert into #t values ('mario.a.gonzalezgonzalez.civ')
insert into #t values ('MARLOWE.RICHMOND.CIV')
insert into #t values ('MARY.A.ADAMS.CIV')
insert into #t values ('Mary.a.beadles.civ')
insert into #t values ('mary.l.dingle2.civ')
insert into #t values ('mary.l.fuhr.civ')
insert into #t values ('mary.m.howes.civ')
insert into #t values ('matthew.c.benigni.mil')
insert into #t values ('Matthew.j.giltenan.mil')
insert into #t values ('Matthew.j.shively.ctr')
insert into #t values ('md.s.rana.civ')
insert into #t values ('MELISSA.S.WALKER.CIV')
insert into #t values ('melody.a.velasquez.mil')
insert into #t values ('merissa.s.mccall.civ')
insert into #t values ('merlin.j.rivera.civ')
insert into #t values ('MICHAEL.A.DIUBALDI.CIV')
insert into #t values ('Michael.a.pelzner.mil')
insert into #t values ('MICHAEL.E.MCINERNEY.MIL')
insert into #t values ('Michael.g.pond.mil')
insert into #t values ('Michael.m.mejia.civ')
insert into #t values ('michael.r.dembeck.mil')
insert into #t values ('michael.r.warpinski.mil')
insert into #t values ('michael.s.goodwin10.civ')
insert into #t values ('michael.t.ertmer.ctr')
insert into #t values ('michael.r.howard18.civ')
insert into #t values ('michele.m.simmons2.civ')
insert into #t values ('michelle.l.davis104.civ')
insert into #t values ('michelle.l.thomas40.civ')
insert into #t values ('monica.h.george.civ')
insert into #t values ('MONICA.M.HOLMES2.MIL')
insert into #t values ('NEWMAN.M.YANG.CIV')
insert into #t values ('nicholas.e.park.mil')
insert into #t values ('nicholas.s.gresko.mil')
insert into #t values ('Nilsa.g.ferrell.civ')
insert into #t values ('noga.hudson.civ')
insert into #t values ('PAMELA.M.STEPHENS6.CIV')
insert into #t values ('Patricia.v.rivera.civ')
insert into #t values ('patrick.d.morse2.civ')
insert into #t values ('PATRICK.J.BADAR.CIV')
insert into #t values ('peter.a.newvine2.mil')
insert into #t values ('PETER.B.THOMAS.CIV')
insert into #t values ('petrina.t.mcintyre.civ')
insert into #t values ('phenize.howell2.mil')
insert into #t values ('rand.a.rodriguez.civ')
insert into #t values ('randy.j.grunow.civ')
insert into #t values ('RANDY.P.LEFEBVRE.MIL')
insert into #t values ('regina.l.dunlap.ctr')
insert into #t values ('reginald.l.freeman10.ctr')
insert into #t values ('RICHARD.M.BAILEY1.CIV')
insert into #t values ('RICHARD.R.REAGAN.CIV')
insert into #t values ('rishawna.m.moss.civ')
insert into #t values ('robby.d.height.civ')
insert into #t values ('Robert.c.washington.civ')
insert into #t values ('ROBERT.J.ORTIZ4.CIV')
insert into #t values ('ROBERT.L.PENA.CIV')
insert into #t values ('Robert.m.golias.civ')
insert into #t values ('robert.t.mullen.mil')
insert into #t values ('roberto.nunez.mil')
insert into #t values ('robyn.l.ackerman.mil')
insert into #t values ('robyn.m.mack.civ')
insert into #t values ('ronald.d.sullivan.civ')
insert into #t values ('Ronald.g.galloway3.civ')
insert into #t values ('russell.t.butler2.civ')
insert into #t values ('ruth.m.foutz.civ')
insert into #t values ('RYAN.J.SILLS.CIV')
insert into #t values ('RYAN.R.DEMARCO.MIL')
insert into #t values ('SABRINA.N.AYERS.CIV')
insert into #t values ('SARAH.C.KELLEY5.MIL')
insert into #t values ('scott.m.brady.civ')
insert into #t values ('seth.w.wacker.mil')
insert into #t values ('shannon.l.graham12.civ')
insert into #t values ('SHARON.R.CRUMBLIN.CIV')
insert into #t values ('SHEERANN.M.MOULTON.CIV')
insert into #t values ('SHONNETTE.G.RANA.MIL')
insert into #t values ('SONJA.L.NELSON2.CIV')
insert into #t values ('SOPHEA.SIV-KAHOLO.CIV')
insert into #t values ('Stacy.j.vicari.civ')
insert into #t values ('stephanie.n.lopez.ctr')
insert into #t values ('STEPHANIE.R.JOHNS.CIV')
insert into #t values ('STEPHEN.G.SHIRLEY2.CIV')
insert into #t values ('steven.garcia14.mil')
insert into #t values ('Steven.l.wallace4.civ')
insert into #t values ('stuart.w.wells.civ')
insert into #t values ('sur.e.stewart.civ')
insert into #t values ('susan.a.malanga.civ')
insert into #t values ('Suzanne.r.torres.civ')
insert into #t values ('TAMIKA.Y.ROBINSON.CIV')
insert into #t values ('tara.n.lancaster.civ')
insert into #t values ('tawayna.s.washington2.mil')
insert into #t values ('terrence.d.obrien.civ')
insert into #t values ('thomas.h.cowan2.civ')
insert into #t values ('thomas.j.kelly2.civ')
insert into #t values ('timothy.c.tarr.civ')
insert into #t values ('timothy.sugars.mil')
insert into #t values ('TONYA.S.SANDERS2.CIV')
insert into #t values ('TRACEY.M.BRUNSON.CIV')
insert into #t values ('TRACYLYNN.C.HOWARD.CIV')
insert into #t values ('trevor.s.voelkel.mil')
insert into #t values ('TRINETTE.L.COLEMAN.CIV')
insert into #t values ('tyler.j.morrow9.mil')
insert into #t values ('TYRONE.WASHINGTON5.MIL')
insert into #t values ('VANESSA.M.JACKSON.CIV')
insert into #t values ('Vanessa.y.millett.civ')
insert into #t values ('Varman.s.chhoeung.mil')
insert into #t values ('VICTORIA.A.DIXON2.CIV')
insert into #t values ('vincent.w.valerian.civ')
insert into #t values ('wesley.a.carter3.civ')
insert into #t values ('wesley.j.kwasney.mil')
insert into #t values ('WILLIAM.A.GLASS8.CIV')
insert into #t values ('william.m.mizell.civ')
insert into #t values ('WILLIAM.M.POLLOCK9.CIV')
insert into #t values ('Willie.Kinsey3.civ')
insert into #t values ('Wilma.l.crawley.civ')
insert into #t values ('XARHYA.WULF.CIV')
insert into #t values ('yomaris.correa.civ')

--Select distinct userPrincipalName from #t

if object_id('tempdb.dbo.#afct') is not null
	drop table #afct

select t.userPrincipalName, uD.uPN, uD.unitName, ap.applicationName, dv.deviceName, up.generatedDateTime
	into #afct

	from #t t

		left outer join 
			(select distinct userKey,userPrincipalName as uPN,unitName, 
					substring(replace(userPrincipalName,'disable.',''),1,charindex('@',replace(userPrincipalName,'disable.',''))-1) as userPrincipalName
				from dbo.userdim
				where charindex('@',replace(userPrincipalName,'disable.','')) > 0) as uD
					on t.userPrincipalName = uD.userPrincipalName
				--order by 2

		 left join [dbo].[upSignInFct] up
			on up.userKey = uD.userKey

		 left join dbo.applicationDim ap
			on up.applicationKey = ap.applicationKey

		 left join dbo.deviceDim dv
			on up.deviceKey = dv.deviceKey

	where ap.applicationName = 'Windows Sign In'
		and (deviceName like 'AFC%' or deviceName like 'PAW%' or deviceName like 'SPE%' or deviceName like 'EUD%'
			or deviceName like 'LAPTOP%' or deviceName like 'TABLET%')

if object_id('tempdb.dbo.#afct_notfound') is not null
	drop table #afct_notfound

select t.userPrincipalName, uD.uPN, uD.unitName, ap.applicationName, dv.deviceName, up.generatedDateTime
	into #afct_notfound

	from #t t

		left outer join 
			(select distinct userKey,userPrincipalName as uPN,unitName, 
					substring(replace(userPrincipalName,'disable.',''),1,charindex('@',replace(userPrincipalName,'disable.',''))-1) as userPrincipalName
				from dbo.userdim
				where charindex('@',replace(userPrincipalName,'disable.','')) > 0) as uD
					on t.userPrincipalName = uD.userPrincipalName
				--order by 2

		 left join [dbo].[upSignInFct] up
			on up.userKey = uD.userKey

		 left join dbo.applicationDim ap
			on up.applicationKey = ap.applicationKey

		 left join dbo.deviceDim dv
			on up.deviceKey = dv.deviceKey

			where uD.userPrincipalName is null

select a.userPrincipalName, a.deviceName, cast(a.generatedDateTime as date) lastLoginDate 
	from (select userPrincipalName, deviceName, generatedDateTime
				, row_number() over (partition by userPrincipalName --, deviceName 
					order by generatedDateTime desc) as rowNumber
			from #afct) a
	where a.rowNumber = 1 

Select row_number() over (partition by userPrincipalName --, deviceName 
					order by generatedDateTime desc) as rowNumber,
					* from #afct where userPrincipalName ='roberto.nunez.mil' order by 6

select distinct userKey,
					substring(replace(userPrincipalName,'disable.',''),1,charindex('@',replace(userPrincipalName,'disable.',''))-1) as userPrincipalName
	into #userDim			
	from dbo.userdim
				where charindex('@',replace(userPrincipalName,'disable.','')) > 0
select distinct t.userPrincipalName, ap.applicationName, dv.deviceName from #t t

		left outer join #userDim uD	
			on t.userPrincipalName = uD.userPrincipalName

		 left join [dbo].[upSignInFct] up
			on up.userKey = uD.userKey

		 left join dbo.applicationDim ap
			on up.applicationKey = ap.applicationKey

		 left join dbo.deviceDim dv
			on up.deviceKey = dv.deviceKey
		Select distinct userKey from	 dbo.deviceDim dv
		join [dbo].[upSignInFct] up
		on up.deviceKey = dv.deviceKey
		join dbo.applicationDim ap
			on up.applicationKey = ap.applicationKey
	where   deviceName IN ('PAW-027955710357',
'PAW-2TK029062W', 'PAW-027955710357','AFCEUD-017045404457') and ap.applicationName = 'Windows Sign In'
	select * from dbo.userdim where  userKey IN 
(501304,
552073,
1128388,
787391,
823006,
680707,
1201386)
 Select * from dbo.deviceDim where deviceKey IN (
 Select distinct deviceKey from [dbo].[upSignInFct] where userKey IN (1996929,1201386) and 
 deviceKey IN (261442,
245057,
262824,
259947,
241447,
241682,
259458,
213753,
242488,
260650))
  Select * from dbo.deviceDim where devicename = 'PAW-027955710357'

deviceKey	deviceId	deviceName
77939	279c6e21-13ef-491c-906d-4fea4574f294	PAW-027955710357
51548	c3a13c5d-8c8d-40d4-8b23-893b479f2659	PAW-027955710357
 Select distinct userKey from [dbo].[upSignInFct]
 where deviceKey IN (51548,77939)

 Select * from dbo.userDim where userKey IN (501304,
680707,
1128388,
823006)
--roberto.nunez.mil
Select  * from dbo.userDim where userPrincipalName like 'roberto.nun%'
N/A


			select * from #t
			select distinct userKey,userPrincipalName as uPN,unitName, 
					substring(replace(userPrincipalName,'disable.',''),1,charindex('@',replace(userPrincipalName,'disable.',''))-1) as userPrincipalName
				from dbo.userdim
				where charindex('@',replace(userPrincipalName,'disable.','')) > 0


				 Select distinct deviceKey,generatedDateTime from [dbo].[upSignInFct] where userKey IN (1996929,1201386) and 
 deviceKey IN (261442,
245057,
262824,
259947,
241447,
241682,
259458,
213753,
242488,
260650) order by 2 desc


Select distinct deviceKey,generatedDateTime from [dbo].[upSignInFct] where userKey IN (1201386) and 
 deviceKey IN (261442,
245057,
262824,
259947,
241447,
241682,
259458,
213753,
242488,
260650) order by 2 desc


241682	ee6e82bf-9d85-4d52-929c-a918bd587b87	DESKTOP-AANOMOP
Select distinct deviceKey,generatedDateTime from [dbo].[upSignInFct] where userKey IN (1201386) and 
 deviceKey IN (
241682) order by 2 Desc

--213753	9229b109-53ae-4b06-8257-15b22ab70343	AFCEUD-017045404457
Select distinct deviceKey,generatedDateTime from [dbo].[upSignInFct] where userKey IN (1201386) and 
 deviceKey IN (
213753) order by 2 Desc
--AVD-C-rojeb30
Select * from dbo.deviceDim where deviceKey IN (261442,
245057,
262824,
259947,
241447,
241682,
259458,
213753,
242488,
260650)

